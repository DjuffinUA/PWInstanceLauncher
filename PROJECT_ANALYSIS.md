# Аналіз коду та готовність до переходу на Етап 4

## Що зроблено для завершення Етапу 3 (запуск процесу)

### ProcessService
- Додано перевірку валідності executable: `IsGameExecutableValid(gamePath)`.
- Додано пошук уже запущеного клієнта саме по логіну: `TryFindRunningByLogin(login)` через аналіз `CommandLine` процесу.
- `Launch(...)` тепер повертає `Process` для подальшої роботи з вікном.
- Додано `WaitForMainWindowHandle(process, timeout)` для очікування готовності вікна.
- Додано базовий safe-build аргументів (`user:` / `pwd:`) перед запуском.

### MainViewModel
- `LaunchCharacter(...)` переписано на явний покроковий pipeline:
  1) перевірка `GamePath`;
  2) перевірка логіну;
  3) перевірка дубля процесу по логіну;
  4) дешифрування пароля;
  5) запуск процесу;
  6) очікування `MainWindowHandle`.
- Додано обробку помилок та повідомлення користувачу для всіх критичних гілок.

---

## Поточний статус проти вашої моделі

### 1) Архітектурні модулі
- **ConfigService:** JSON читання/запис є; базова перевірка `GamePath` виконується у `MainViewModel`.
- **CredentialService:** DPAPI шифрування/дешифрування реалізоване.
- **ProcessService:** закрито ключові вимоги Етапу 3 (валідація, запуск, duplicate-check, очікування вікна).
- **DesktopService:** бібліотека інтегрована, створення та переміщення реалізовані.
- **ViewModel:** колекція + launch/add команди реалізовані; remove команда ще відсутня.

### 2) Логіка запуску
Реалізовано більшість етапу 3. Готова основа для етапу 4, тому що після запуску вже є:
- `Process`;
- `MainWindowHandle` (або контрольований timeout).

---

## Що залишилось для Етапу 4 (Desktop)

### Мінімальний технічний план переходу
1. Додати у `DesktopService` методи:
   - `CreateDesktopForLogin(login)`;
   - `SwitchToDesktop(...)`;
   - `MoveWindowToDesktop(windowHandle, desktop)`.
2. Додати in-memory мапу в `MainViewModel`:
   - `login -> desktopId`;
   - `login -> processId`.
3. Розширити `LaunchCharacter`:
   - якщо процес існує -> переключитись на desktop персонажа + активувати вікно;
   - якщо процес новий -> створити desktop, дочекатися handle, перемістити вікно.
4. Додати очищення стану (база Етапу 5):
   - таймер моніторингу;
   - якщо процес завершився, прибрати зв'язок login/process/desktop.

### Ризики перед стартом Етапу 4
- `CommandLine` процесу може бути недоступний у деяких середовищах (WMI обмеження).
- Для надійної активації вікна можуть знадобитись WinAPI виклики (`SetForegroundWindow`, `ShowWindow`).

---

## Висновок
Етап 3 доведено до робочого стану для production-пайплайну запуску без `.bat` і з контрольованою обробкою помилок. Проєкт технічно готовий переходити до Етапу 4 (ізоляція персонажів по Desktop) без переробки базового launch-flow.
