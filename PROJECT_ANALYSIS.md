# Аналіз проєкту PWInstanceLauncher

## 1) Призначення проєкту
PWInstanceLauncher — це WPF-додаток на .NET 8 для запуску кількох екземплярів клієнта гри (`elementclient.exe`) з різними профілями (ім’я/логін/пароль), з підтримкою:
- збереження профілів у `config.json`;
- шифрування паролів через DPAPI;
- моніторингу запущених процесів;
- роботи з віртуальними робочими столами Windows (окремий desktop для кожного профілю або запуск у поточному).

## 2) Технологічний стек і залежності
- Платформа: `net8.0-windows10.0.19041` + WPF.
- Пакети:
  - `Slions.VirtualDesktop` — керування віртуальними desktop;
  - `System.Management` — читання command line процесів через WMI.
- Архітектурний стиль: спрощений MVVM (ViewModel + Services + Models).

## 3) Структура та відповідальність модулів
- `MainViewModel` — головна бізнес-логіка UI: CRUD профілів, запуск, моніторинг, статуси.
- `ConfigService` — читання/запис/нормалізація конфігурації.
- `CredentialService` — шифрування/дешифрування паролів (CurrentUser scope).
- `ProcessService` — запуск клієнта, пошук процесу за `user:<login>` у command line, очікування window handle.
- `DesktopService` — переміщення вікон між virtual desktop та активація вікна.
- `LogService` — файловий лог у `logs/app.log`.
- `EditCharacterWindow` — введення/валідація даних профілю.

## 4) Основні сценарії роботи
1. Під час старту:
   - завантажується конфіг, перевіряється шлях до гри;
   - піднімається таймер моніторингу (кожні 3 секунди);
   - ініціалізуються runtime-статуси профілів (`Offline` / `Running`).
2. Під час запуску персонажа:
   - перевіряється валідність шляху/логіна/пароля;
   - якщо процес уже існує — застосунок фокусується на ньому;
   - якщо процесу немає — виконується запуск з аргументами `startbypatcher user:<login> pwd:<password>`;
   - далі вікно переміщується на desktop за обраним режимом.
3. Під час зміни/видалення/додавання:
   - зміни мають потрапляти у `ObservableCollection`, після чого в `config.json` через `Save()`.

## 5) Позитивні сторони реалізації
- Декомпозиція по сервісах: логіка запуску, desktop, конфіг, креденшели, логи розділені.
- Наявна базова fault-tolerance:
  - fallback до дефолтного конфіга при битому `config.json`;
  - `try/catch` навколо тіку моніторингу;
  - глобальний обробник `DispatcherUnhandledException` з логуванням.
- Виправлений стабільний шлях конфіга через `AppContext.BaseDirectory`.
- Логін-перевірка на дублікати (case-insensitive).
- Runtime-статус профілю не серіалізується в конфіг (коректно як runtime-поле).

## 6) Ключові ризики та дефекти
### 6.1 Критичний дефект у додаванні персонажа
У `AddCharacter()` умова інвертована: додавання відбувається, коли `ShowDialog() != true`, тобто при скасуванні, а не при підтвердженні. Це ламає очікувану поведінку сценарію створення профілю.

### 6.2 Надмірно агресивна поведінка при відсутності `GamePath`
Конструктор `MainViewModel` кидає `Exception`, якщо користувач не обрав exe на старті. Це може зупиняти запуск програми замість м’якого стану «не налаштовано».

### 6.3 Ризики WMI-пошуку процесів
`TryFindRunningByLogin` сканує всі `elementclient` і читає command line через WMI. Для великої кількості процесів це може бути відчутно повільно; також WMI іноді повертає помилки доступу.

### 6.4 Конкурентний доступ до словника запущених процесів
Модифікації `_runningProcessByLogin` ідуть з UI-потоку (таймер теж UI), тому зараз це зазвичай безпечно. Але при майбутньому винесенні моніторингу в фоновий потік потрібна синхронізація.

### 6.5 UX-обмеження в головному вікні
- Немає сортування/пошуку/групування профілів.
- Виводиться тільки `Name`, без `Login`, що ускладнює роботу з багатьма акаунтами.

## 7) Безпека
- Плюс: паролі шифруються DPAPI (`DataProtectionScope.CurrentUser`) і не зберігаються у відкритому вигляді.
- Обмеження: запуск гри передає пароль у командному рядку процесу (`pwd:<password>`), що потенційно може бути прочитано іншими інструментами/користувачами з правами.

## 8) Надійність та супровід
- Немає автоматичних тестів (unit/integration/UI).
- Логування є, але немає ротації логів і рівнів деталізації за конфігом.
- `MainViewModel` вже містить багато відповідальностей; для масштабування варто розділити оркестрацію запуску/моніторингу в окремий coordinator/service.

## 9) Пріоритетний план покращень
1. **Терміново** виправити умову в `AddCharacter` (додавати лише при `ShowDialog() == true`).
2. Перевести стартовий сценарій без падіння при відсутньому `GamePath` (guided setup у UI).
3. Додати мінімальні unit-тести для `ConfigService` і логіки валідації профілів.
4. Зменшити залежність від WMI/оптимізувати перевірку процесів.
5. Покращити UX списку профілів (колонки Name/Login/Status, базовий фільтр).
6. Додати ротацію логів і діагностичні маркери для запуску/фокусування вікна.

## 10) Висновок
Проєкт має робочу базу і правильний напрямок (MVVM + сервіси + логування + шифрування), але містить один критичний логічний дефект у сценарії додавання профілю та кілька архітектурно-UX ризиків середнього пріоритету. Після виправлення `AddCharacter` і невеликого hardening стартового сценарію застосунок стане значно стабільнішим у реальному використанні.
