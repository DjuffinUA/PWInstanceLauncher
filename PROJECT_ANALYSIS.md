# Повний аналіз коду PWInstanceLauncher + звіт по етапах

## 1) Що перевірено
Проведено аудит ключових шарів:
- `ConfigService`, `CredentialService`, `ProcessService`, `DesktopService`, `LogService`;
- `MainViewModel` (основний orchestration flow);
- UI (`MainWindow.xaml`, `EditCharacterWindow`);
- моделі (`AppConfig`, `CharacterProfile`);
- глобальний старт/обробка помилок (`App.xaml.cs`).

---

## 2) Виявлені помилки/неточності та виправлення

### Виявлено
1. **Ризик NullReference у конструкторі `MainViewModel`:** виклик `TryEnsureGamePath()` міг викликати `Save()` до ініціалізації `Characters`.
2. **Відсутність перевірки унікальності логіну персонажа:** допускались дублікати `Login`, що ламало duplicate-check та runtime-мапінг.
3. **Недостатня прозорість оператору на Етапі 6:** не було user-visible статусу останньої операції та зручної зміни `GamePath`.
4. **Недостатня діагностика збоїв:** потрібне централізоване логування і глобальний перехват UI-виключень.

### Виправлено
1. **Порядок ініціалізації в `MainViewModel`:** `Characters` ініціалізується одразу після `Config`.
2. **Унікальність логіну:** додано `IsLoginUnique(...)`, перевірка в `AddCharacter` і `EditCharacter`.
3. **Етап 6 UX/операторські контролі:**
   - `StatusMessage` у VM + відображення внизу головного вікна;
   - `ChangeGamePathCommand` + кнопка зміни шляху;
   - відображення поточного `GamePath` у UI.
4. **Логування/винятки:**
   - додано `LogService` (`logs/app.log`);
   - глобальний `DispatcherUnhandledException` у `App.xaml.cs`.

---

## 3) Повторний аналіз логіки після виправлень

### Launch-flow
- Валідація профілю та `GamePath` виконується перед запуском.
- Для вже запущеного персонажа: фокус/desktop-switch без повторного запуску.
- Для нового запуску: decrypt -> start process -> wait window handle -> desktop routing.

### Моніторинг (Етап 5)
- Таймер кожні 3 сек.
- Cleanup завершених PID.
- Оновлення статусу `Running/Offline` без перезапуску застосунку.

### Полірування (Етап 6)
- Є логування, глобальний перехват критичних винятків, статус останньої дії, зміна `GamePath` з UI.

---

## 4) Звіт по етапах

### Етап 1 — База проєкту
- WPF + MVVM каркас: ✅
- JSON конфіг + fallback + нормалізація: ✅
- Валідація `GamePath` при старті: ✅
- **Статус:** **закрито**.

### Етап 2 — Профілі персонажів
- `CharacterProfile`, add/edit/remove: ✅
- DPAPI шифрування пароля: ✅
- Захист від перезапису пароля пустим значенням: ✅
- Додано перевірку унікальності логіну: ✅
- **Статус:** **закрито**.

### Етап 3 — Запуск процесу
- `ProcessStartInfo` і запуск без `.bat`: ✅
- Duplicate-check по логіну: ✅
- Очікування `MainWindowHandle`, обробка помилок: ✅
- **Статус:** **закрито функціонально**.

### Етап 4 — Робота з Desktop
- Створення/switch/move desktop через `Slions.VirtualDesktop`: ✅
- Інтеграція в launch-flow для existing/new process: ✅
- **Статус:** **закрито функціонально**.

### Етап 5 — Перевірка стану
- Таймер моніторингу: ✅
- Cleanup стану після завершення процесу: ✅
- Можливість коректного перезапуску: ✅
- **Статус:** **закрито функціонально**.

### Етап 6 — Полірування
- Логування: ✅
- Глобальна обробка UI виключень: ✅
- Індикація статусу (`Running/Offline` + `StatusMessage`): ✅
- Зміна `GamePath` з UI: ✅
- **Статус:** **закрито функціонально**.

---

## 5) Залишкові технічні ризики
1. Пошук процесу за логіном залежить від WMI (`Win32_Process.CommandLine`).
2. Desktop-мапінг по логіну in-memory і не персиститься між рестартами застосунку.
